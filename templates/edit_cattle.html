{% extends "base.html" %}

{% block title %}Editar Gado - Auditoria de Rebanho{% endblock %}

{% block content %}
<section class="content-section form-section">
    <h2>Editar Gado (ID: {{ cattle.id }})</h2>

    <form id="edit-cattle-form" method="post"> <!-- JS will handle PUT request -->
        <input type="hidden" name="cattle_id" value="{{ cattle.id }}">

        <label for="type">Tipo:</label>
        <select id="type" name="type" required>
            <option value="cow" {% if cattle.type == "cow" %}selected{% endif %}>Vaca (Fêmea)</option>
            <option value="bull" {% if cattle.type == "bull" %}selected{% endif %}>Boi (Macho)</option>
        </select>

        <label for="birth_date">Data de Nascimento:</label>
        <input type="date" id="birth_date" name="birth_date" value="{{ cattle.birth_date if cattle.birth_date else "" }}">

        <label for="weight">Peso (kg):</label>
        <input type="number" step="0.1" id="weight" name="weight" value="{{ cattle.weight if cattle.weight else "" }}">

        <label for="mother_id">ID da Mãe (Opcional, se Vaca):</label>
        <input type="number" id="mother_id" name="mother_id" value="{{ cattle.mother_id if cattle.mother_id else "" }}">
        <small>Deixe em branco se não aplicável. A mãe deve ser uma Vaca já cadastrada.</small>

        <button type="submit" class="btn-primary">Salvar Alterações</button>
    </form>

    <p><a href="/cattle-list">Cancelar e Voltar para Lista</a></p>

</section>
{% endblock %}

{% block scripts_extra %}
<script>
    // Handle form submission via Fetch API for PUT request
    const editCattleForm = document.getElementById("edit-cattle-form");
    if (editCattleForm) {
        editCattleForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(editCattleForm);
            const cattleId = formData.get("cattle_id");
            const data = {
                type: formData.get("type"),
                birth_date: formData.get("birth_date") || null,
                weight: formData.get("weight") ? parseFloat(formData.get("weight")) : null,
                mother_id: formData.get("mother_id") ? parseInt(formData.get("mother_id")) : null
            };

            // Clean up null/empty fields based on API expectation
            if (!data.birth_date) delete data.birth_date;
            if (data.weight === null) delete data.weight;
            if (data.mother_id === null) delete data.mother_id;

            try {
                const response = await fetch(`/cattle/${cattleId}`, { // Use the API endpoint with PUT
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert(`Dados do gado (ID: ${result.id}) atualizados com sucesso!`);
                // Redirect back to the list after successful update
                window.location.href = "/cattle-list";
            } catch (error) {
                console.error("Erro ao atualizar gado:", error);
                alert(`Erro ao atualizar gado: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

