{% extends "base.html" %}

{% block title %}Editar Gado - Auditoria de Rebanho{% endblock %}

{% block content %}
<section class="content-section form-section">
    <h2>Editar Gado (ID: {{ cattle.id }})</h2>

    <form id="edit-cattle-form" method="post"> <!-- JS will handle PUT request -->
        <input type="hidden" name="cattle_id" value="{{ cattle.id }}">

        <label for="name">Nome:</label>
        <input type="text" id="name" name="name" value="{{ cattle.name }}" required>

        <label for="identification">Identificação:</label>
        <input type="text" id="identification" name="identification" value="{{ cattle.identification if cattle.identification else '' }}">

        <label for="race">Raça:</label>
        <input type="text" id="race" name="race" value="{{ cattle.race }}" required>

        <label for="gender">Gênero:</label>
        <select id="gender" name="gender" required>
            <option value="FEMALE" {% if cattle.gender == "FEMALE" %}selected{% endif %}>Fêmea</option>
            <option value="MALE" {% if cattle.gender == "MALE" %}selected{% endif %}>Macho</option>
        </select>

        <label for="birth_date">Data de Nascimento:</label>
        <input type="date" id="birth_date" name="birth_date" value="{{ cattle.birth_date if cattle.birth_date else '' }}">

        <label for="acquisition_date">Data de Aquisição:</label>
        <input type="date" id="acquisition_date" name="acquisition_date" value="{{ cattle.acquisition_date if cattle.acquisition_date else '' }}">

        <label for="acquisition_value">Valor de Aquisição (R$):</label>
        <input type="number" step="0.01" id="acquisition_value" name="acquisition_value" value="{{ cattle.acquisition_value if cattle.acquisition_value else '' }}">

        <label for="status">Status:</label>
        <select id="status" name="status">
            <option value="ACTIVE" {% if cattle.status == "ACTIVE" %}selected{% endif %}>Ativo</option>
            <option value="SOLD" {% if cattle.status == "SOLD" %}selected{% endif %}>Vendido</option>
            <option value="DECEASED" {% if cattle.status == "DECEASED" %}selected{% endif %}>Falecido</option>
            <option value="TRANSFERRED" {% if cattle.status == "TRANSFERRED" %}selected{% endif %}>Transferido</option>
        </select>

        <label for="mother_id">ID da Mãe:</label>
        <input type="number" id="mother_id" name="mother_id" value="{{ cattle.mother_id if cattle.mother_id else '' }}">

        <label for="father_id">ID do Pai:</label>
        <input type="number" id="father_id" name="father_id" value="{{ cattle.father_id if cattle.father_id else '' }}">

        <label for="origin">Origem:</label>
        <input type="text" id="origin" name="origin" value="{{ cattle.origin if cattle.origin else '' }}">

        <label for="notes">Observações:</label>
        <textarea id="notes" name="notes" rows="3">{{ cattle.notes if cattle.notes else '' }}</textarea>

        <button type="submit" class="btn-primary">Salvar Alterações</button>
    </form>

    <p><a href="/cattle-list">Cancelar e Voltar para Lista</a></p>

</section>
{% endblock %}

{% block scripts_extra %}
<script>
    // Handle form submission via Fetch API for PUT request
    const editCattleForm = document.getElementById("edit-cattle-form");
    if (editCattleForm) {
        editCattleForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(editCattleForm);
            const cattleId = formData.get("cattle_id");
            const data = {
                name: formData.get("name"),
                identification: formData.get("identification") || null,
                race: formData.get("race"),
                gender: formData.get("gender"),
                birth_date: formData.get("birth_date") || null,
                acquisition_date: formData.get("acquisition_date") || null,
                acquisition_value: formData.get("acquisition_value") ? parseFloat(formData.get("acquisition_value")) : null,
                status: formData.get("status"),
                mother_id: formData.get("mother_id") ? parseInt(formData.get("mother_id")) : null,
                father_id: formData.get("father_id") ? parseInt(formData.get("father_id")) : null,
                origin: formData.get("origin") || null,
                notes: formData.get("notes") || null
            };

            // Clean up null/empty fields based on API expectation
            if (!data.identification) delete data.identification;
            if (!data.birth_date) delete data.birth_date;
            if (!data.acquisition_date) delete data.acquisition_date;
            if (data.acquisition_value === null) delete data.acquisition_value;
            if (data.mother_id === null) delete data.mother_id;
            if (data.father_id === null) delete data.father_id;
            if (!data.origin) delete data.origin;
            if (!data.notes) delete data.notes;

            try {
                const response = await fetch(`/cattle/${cattleId}`, { // Use the API endpoint with PUT
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert(`Dados do gado (ID: ${result.id}) atualizados com sucesso!`);
                // Redirect back to the list after successful update
                window.location.href = "/cattle-list";
            } catch (error) {
                console.error("Erro ao atualizar gado:", error);
                alert(`Erro ao atualizar gado: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

