{% extends "base.html" %}

{% block title %}
    {% if action == 'create' %}Adicionar Gado{% else %}Editar Gado{% endif %} - Auditoria de Rebanho
{% endblock %}

{% block content %}

<section class="content-section form-section">
    <h2>{% if action == 'create' %}Adicionar Gado (Boi ou Vaca){% else %}Editar Gado (ID: {{ cattle.id }}){% endif %}</h2>
    <form id="cattle-form" action="/cattle/" method="post">
        <label for="name">Nome:</label>
        <input type="text" id="name" name="name" value="{{ cattle.name if cattle else '' }}" required>

        <label for="identification">Identificação (Opcional):</label>
        <input type="text" id="identification" name="identification" value="{{ cattle.identification if cattle and cattle.identification else '' }}">

        <label for="race">Raça:</label>
        <input type="text" id="race" name="race" value="{{ cattle.race if cattle else '' }}" required>

        <label for="gender">Gênero:</label>
        <select id="gender" name="gender" required>
            <option value="" disabled {% if not cattle %}selected{% endif %}>Selecione o gênero</option>
            <option value="FEMALE" {% if cattle and cattle.gender == "FEMALE" %}selected{% endif %}>Fêmea</option>
            <option value="MALE" {% if cattle and cattle.gender == "MALE" %}selected{% endif %}>Macho</option>
        </select>

        <label for="birth_date">Data de Nascimento:</label>
        <input type="date" id="birth_date" name="birth_date" value="{{ cattle.birth_date if cattle and cattle.birth_date else '' }}">

        <label for="acquisition_date">Data de Aquisição:</label>
        <input type="date" id="acquisition_date" name="acquisition_date" value="{{ cattle.acquisition_date if cattle and cattle.acquisition_date else '' }}">

        <label for="acquisition_value">Valor de Aquisição (R$):</label>
        <input type="number" step="0.01" id="acquisition_value" name="acquisition_value" value="{{ cattle.acquisition_value if cattle and cattle.acquisition_value else '' }}">

        <label for="status">Status:</label>
        <select id="status" name="status">
            <option value="ACTIVE" {% if not cattle or cattle.status == "ACTIVE" %}selected{% endif %}>Ativo</option>
            <option value="SOLD" {% if cattle and cattle.status == "SOLD" %}selected{% endif %}>Vendido</option>
            <option value="DECEASED" {% if cattle and cattle.status == "DECEASED" %}selected{% endif %}>Falecido</option>
            <option value="TRANSFERRED" {% if cattle and cattle.status == "TRANSFERRED" %}selected{% endif %}>Transferido</option>
        </select>

        <label for="mother_id">ID da Mãe (Opcional):</label>
        <input type="number" id="mother_id" name="mother_id" value="{{ cattle.mother_id if cattle and cattle.mother_id else '' }}">

        <label for="father_id">ID do Pai (Opcional):</label>
        <input type="number" id="father_id" name="father_id" value="{{ cattle.father_id if cattle and cattle.father_id else '' }}">

        <label for="origin">Origem:</label>
        <input type="text" id="origin" name="origin" value="{{ cattle.origin if cattle and cattle.origin else '' }}">

        <label for="notes">Observações:</label>
        <textarea id="notes" name="notes" rows="3">{{ cattle.notes if cattle and cattle.notes else '' }}</textarea>

        <button type="submit">
            {% if action == 'create' %}Adicionar Gado{% else %}Salvar Alterações{% endif %}
        </button>
    </form>
    <p><a href="{% if action == 'create' %}/{% else %}/cattle-list{% endif %}">
        {% if action == 'create' %}Voltar ao Dashboard{% else %}Cancelar e Voltar para Lista{% endif %}
    </a></p>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
    const cattleForm = document.getElementById("cattle-form");
    const action = '{{ action }}';
    const cattleId = {% if cattle %}'{{ cattle.id }}'{% else %}null{% endif %};

    if (cattleForm) {
        cattleForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(cattleForm);
            const data = {
                name: formData.get("name"),
                identification: formData.get("identification") || null,
                race: formData.get("race"),
                gender: formData.get("gender"),
                birth_date: formData.get("birth_date") || null,
                acquisition_date: formData.get("acquisition_date") || null,
                acquisition_value: formData.get("acquisition_value") ? parseFloat(formData.get("acquisition_value")) : null,
                status: formData.get("status"),
                mother_id: formData.get("mother_id") ? parseInt(formData.get("mother_id")) : null,
                father_id: formData.get("father_id") ? parseInt(formData.get("father_id")) : null,
                origin: formData.get("origin") || null,
                notes: formData.get("notes") || null
            };

            // Remove null fields if necessary, depending on API validation
            if (!data.identification) delete data.identification;
            if (!data.birth_date) delete data.birth_date;
            if (!data.acquisition_date) delete data.acquisition_date;
            if (data.acquisition_value === null) delete data.acquisition_value;
            if (data.mother_id === null) delete data.mother_id;
            if (data.father_id === null) delete data.father_id;
            if (!data.origin) delete data.origin;
            if (!data.notes) delete data.notes;

            try {
                let response;
                if (action === 'create') {
                    response = await fetch("/cattle/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                } else {
                    response = await fetch(`/cattle/${cattleId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (action === 'create') {
                    alert(`Gado adicionado com sucesso! ID: ${result.id}`);
                    cattleForm.reset();
                } else {
                    alert(`Dados do gado (ID: ${result.id}) atualizados com sucesso!`);
                    window.location.href = "/cattle-list";
                }
            } catch (error) {
                console.error("Erro ao processar gado:", error);
                alert(`Erro ao ${action === 'create' ? 'adicionar' : 'atualizar'} gado: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

