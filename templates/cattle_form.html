{% extends "base.html" %}

{% block title %}
    {% if action == 'create' %}Adicionar Gado{% else %}Editar Gado{% endif %} - Auditoria de Rebanho
{% endblock %}

{% block content %}

<section class="content-section form-section">
    <h2>{% if action == 'create' %}Adicionar Novo Gado (Boi ou Vaca){% else %}Editar Gado (ID: {{ cattle.id }}){% endif %}</h2>
    <form id="cattle-form" action="/cattle/" method="post">
        <label for="type">Tipo:</label>
        <select id="type" name="type" required>
            <option value="" disabled {% if not cattle %}selected{% endif %}>Selecione o tipo</option>
            <option value="cow" {% if cattle and cattle.type == "cow" %}selected{% endif %}>Vaca (Fêmea)</option>
            <option value="bull" {% if cattle and cattle.type == "bull" %}selected{% endif %}>Boi (Macho)</option>
        </select>

        <label for="name">Nome:</label>
        <input type="text" id="name" name="name" value="{{ cattle.name if cattle else '' }}" required>

        <label for="birth_date">Data de Nascimento:</label>
        <input type="date" id="birth_date" name="birth_date" value="{{ cattle.birth_date if cattle and cattle.birth_date else '' }}">

        <label for="weight">Peso (kg):</label>
        <input type="number" step="0.1" id="weight" name="weight" value="{{ cattle.weight if cattle and cattle.weight else '' }}">

        <label for="mother_id">ID da Mãe (Opcional, se Vaca):</label>
        <input type="number" id="mother_id" name="mother_id" value="{{ cattle.mother_id if cattle and cattle.mother_id else '' }}">
        <small>Deixe em branco se não aplicável ou desconhecido.</small>

        <button type="submit">
            {% if action == 'create' %}Adicionar Gado{% else %}Salvar Alterações{% endif %}
        </button>
    </form>
    <p><a href="{% if action == 'create' %}/{% else %}/cattle-list{% endif %}">
        {% if action == 'create' %}Voltar ao Dashboard{% else %}Cancelar e Voltar para Lista{% endif %}
    </a></p>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
    const cattleForm = document.getElementById("cattle-form");
    const action = '{{ action }}';
    const cattleId = {% if cattle %}'{{ cattle.id }}'{% else %}null{% endif %};

    if (cattleForm) {
        cattleForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(cattleForm);
            const data = {
                name: formData.get("name"),
                type: formData.get("type"),
                birth_date: formData.get("birth_date") || null,
                weight: formData.get("weight") ? parseFloat(formData.get("weight")) : null,
                mother_id: formData.get("mother_id") ? parseInt(formData.get("mother_id")) : null
            };

            // Remove null fields if necessary, depending on API validation
            if (!data.birth_date) delete data.birth_date;
            if (data.weight === null) delete data.weight;
            if (data.mother_id === null) delete data.mother_id;

            try {
                let response;
                if (action === 'create') {
                    response = await fetch("/cattle/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                } else {
                    response = await fetch(`/cattle/${cattleId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (action === 'create') {
                    alert(`Gado adicionado com sucesso! ID: ${result.id}`);
                    cattleForm.reset();
                } else {
                    alert(`Dados do gado (ID: ${result.id}) atualizados com sucesso!`);
                    window.location.href = "/cattle-list";
                }
            } catch (error) {
                console.error("Erro ao processar gado:", error);
                alert(`Erro ao ${action === 'create' ? 'adicionar' : 'atualizar'} gado: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

