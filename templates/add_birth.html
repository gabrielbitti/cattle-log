{% extends "base.html" %}

{% block title %}Registrar Nascimento - Auditoria de Rebanho{% endblock %}

{% block content %}
<section class="content-section form-section">
    <h2>Registrar Novo Nascimento</h2>
    <form id="add-birth-form" action="/cattle/birth" method="post"> <!-- Action might be handled by JS -->
        <label for="mother_id">ID da Vaca Mãe:</label>
        <input type="number" id="mother_id" name="mother_id" required>

        <label for="type">Tipo:</label>
        <select id="type" name="type" required>
            <option value="" disabled selected>Selecione o tipo</option>
            <option value="cow">Vaca (Fêmea)</option>
            <option value="bull">Boi (Macho)</option>
        </select>

        <label for="name">Nome:</label>
        <input type="text" id="name" name="name" required>

        <label for="calf_birth_date">Data de Nascimento do Bezerro:</label>
        <input type="date" id="calf_birth_date" name="calf_birth_date" required>

        <label for="calf_weight">Peso do Bezerro ao Nascer (kg):</label>
        <input type="number" step="0.1" id="calf_weight" name="calf_weight">
        <small>Opcional.</small>

        <button type="submit">Registrar Nascimento</button>
    </form>
    <p><a href="/">Voltar ao Dashboard</a></p>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
    // Basic JS to handle form submission via fetch API
    const addBirthForm = document.getElementById("add-birth-form");
    if (addBirthForm) {
        addBirthForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(addBirthForm);
            const data = {
                name: formData.get("name"),
                type: formData.get("type"),
                mother_id: parseInt(formData.get("mother_id")),
                calf_birth_date: formData.get("calf_birth_date"),
                calf_weight: formData.get("calf_weight") ? parseFloat(formData.get("calf_weight")) : null
            };

            // Remove null fields if necessary
            if (data.calf_weight === null) delete data.calf_weight;

            try {
                const response = await fetch("/cattle/birth", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                // Note: The API currently returns the created calf record.
                alert(`Nascimento registrado com sucesso! ID do bezerro: ${result.id}`);
                // Optionally redirect or clear form
                // window.location.href = "/";
                addBirthForm.reset();
            } catch (error) {
                console.error("Erro ao registrar nascimento:", error);
                alert(`Erro ao registrar nascimento: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

