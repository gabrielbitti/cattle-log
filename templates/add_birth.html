{% extends "base.html" %}

{% block title %}Registrar Nascimento - Auditoria de Rebanho{% endblock %}

{% block content %}
<section class="content-section form-section">
    <h2>Registrar Nascimento</h2>
    <form id="add-birth-form" action="/cattle/birth" method="post"> <!-- Action might be handled by JS -->
        <label for="name">Nome:</label>
        <input type="text" id="name" name="name" required>

        <label for="gender">Gênero:</label>
        <select id="gender" name="gender" required>
            <option value="" disabled selected>Selecione o gênero</option>
            <option value="FEMALE">Fêmea</option>
            <option value="MALE">Macho</option>
        </select>

        <label for="birth_date">Data de Nascimento:</label>
        <input type="date" id="birth_date" name="birth_date" required>

        <label for="mother_id">ID da Mãe:</label>
        <input type="number" id="mother_id" name="mother_id" required>

        <label for="father_id">ID do Pai (Opcional):</label>
        <input type="number" id="father_id" name="father_id">

        <label for="race">Raça (Opcional - herda da mãe se vazio):</label>
        <input type="text" id="race" name="race">

        <label for="notes">Observações:</label>
        <textarea id="notes" name="notes" rows="3"></textarea>

        <button type="submit">Registrar Nascimento</button>
    </form>
    <p><a href="/">Voltar ao Dashboard</a></p>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
    // Basic JS to handle form submission via fetch API
    const addBirthForm = document.getElementById("add-birth-form");
    if (addBirthForm) {
        addBirthForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(addBirthForm);
            const data = {
                name: formData.get("name"),
                gender: formData.get("gender"),
                birth_date: formData.get("birth_date"),
                mother_id: parseInt(formData.get("mother_id")),
                father_id: formData.get("father_id") ? parseInt(formData.get("father_id")) : null,
                race: formData.get("race") || null,
                notes: formData.get("notes") || null
            };

            // Remove null fields if necessary
            if (data.father_id === null) delete data.father_id;
            if (!data.race) delete data.race;
            if (!data.notes) delete data.notes;

            try {
                const response = await fetch("/cattle/birth", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                // Note: The API currently returns the created calf record.
                alert(`Nascimento registrado com sucesso! ID do bezerro: ${result.id}`);
                // Optionally redirect or clear form
                // window.location.href = "/";
                addBirthForm.reset();
            } catch (error) {
                console.error("Erro ao registrar nascimento:", error);
                alert(`Erro ao registrar nascimento: ${error.message}`);
            }
        });
    }
</script>
{% endblock %}

